<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Anime Tower Defense - GitHub Version</title>
<style>
  body{margin:0;background:#051022;color:#eaf6ff;font-family:Inter,Arial}
  .wrap{max-width:1100px;margin:18px auto;display:flex;gap:16px;padding:12px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  #game{background:#000;display:block;border-radius:8px}
  .sidebar{width:320px}
  .stat{display:flex;gap:8px;margin-bottom:10px}
  .stat div{flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}
  button{background:#10b981;border:none;color:#022;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .muted{color:#9aa6b2;font-size:13px}
  .spots{margin-top:10px}
  .spot{padding:6px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .log{margin-top:10px;max-height:220px;overflow:auto;padding:8px;border-radius:6px;background:rgba(255,255,255,0.01);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" style="flex:1">
    <canvas id="game" width="820" height="820"></canvas>
  </div>

  <div class="panel sidebar">
    <h3>Anime Tower Defense — GitHub Assets</h3>
    <div class="stat">
      <div>Tiền<br><strong id="money">150</strong></div>
      <div>HP<br><strong id="hp">10</strong></div>
      <div>Wave<br><strong id="wave">0</strong></div>
    </div>

    <div class="muted">Chỉ được đặt tháp trên 6 ô tròn.</div>

    <div style="margin-top:10px">
      <button id="start-wave">Start Wave</button>
      <button id="sell-mode" style="background:#ffd86b;color:#072028">Bật chế độ bán</button>
    </div>

    <div class="spots">
      <div class="muted" style="margin-top:8px">Các ô đặt tháp:</div>
      <div id="spots-list"></div>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:700">Chọn loại tháp:</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="select-tower">Chọn tháp (Lv1)</button>
        <button id="upgrade-btn" style="background:#7de3ff;color:#022">Upgrade</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>
</div>

<script>
// ============================
// LOAD PNG TỪ FOLDER /assets/
// ============================
const ASSETS = {
  map: "assets/map.png",
  towers: [
    "assets/tower_lv1.png",
    "assets/tower_lv2.png",
    "assets/tower_lv3.png",
    "assets/tower_lv4.png"
  ],
  enemies: [
    "assets/enemy_1.png",
    "assets/enemy_2.png",
    "assets/enemy_3.png",
    "assets/enemy_4.png"
  ]
};

// ============================
// GAME ENGINE
// ============================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let imgs = {};
let loaded = 0, totalImgs = 0;

const toLoad = [ASSETS.map, ...ASSETS.towers, ...ASSETS.enemies];
totalImgs = toLoad.length;

toLoad.forEach(src=>{
  const img = new Image();
  img.src = src;
  img.onload = ()=>{ imgs[src]=img; loaded++; if(loaded===totalImgs) init(); };
  img.onerror = ()=>{ console.error("Load lỗi:", src); loaded++; if(loaded===totalImgs) init(); };
});

// ========= STATE ===========
const state = { money:150, hp:10, wave:0, running:false, sellMode:false, selectedTowerIdx:0 };
function log(t){ const d=document.createElement("div"); d.textContent=t; logEl.prepend(d); }
const logEl = document.getElementById("log");

// ========= SPOTS ===========
const spotsPercent = [
  {x:0.18,y:0.16},
  {x:0.36,y:0.22},
  {x:0.60,y:0.28},
  {x:0.20,y:0.52},
  {x:0.44,y:0.68},
  {x:0.78,y:0.84}
];
let spots = [];
let towers = new Array(6).fill(null);

// ========= PATH ============
const pathPercent = [
  {x:0.12,y:0.12},{x:0.24,y:0.18},{x:0.36,y:0.28},{x:0.48,y:0.38},
  {x:0.60,y:0.48},{x:0.68,y:0.58},{x:0.78,y:0.70},{x:0.88,y:0.78}
];
function pct(p){ return {x:Math.round(p.x*W), y:Math.round(p.y*H)}; }

let enemies = [];
const enemySize = 64;

// ================= INIT ==================
function init(){
  spots = spotsPercent.map(p=>pct(p));

  const spotsList = document.getElementById("spots-list");
  spotsList.innerHTML = "";
  spots.forEach((s,i)=>{
    let div=document.createElement("div");
    div.className="spot";
    div.innerHTML=`<div>Ô ${i+1}</div><div><button data-i="${i}">Đặt</button></div>`;
    spotsList.appendChild(div);
  });

  document.querySelectorAll("#spots-list button").forEach(btn=>{
    btn.onclick = ()=> placeTower(Number(btn.dataset.i));
  });

  document.getElementById("select-tower").onclick = ()=>{
    state.selectedTowerIdx = (state.selectedTowerIdx+1)%4;
    document.getElementById("select-tower").textContent = "Chọn tháp (Lv " + (state.selectedTowerIdx+1) + ")";
  };

  document.getElementById("upgrade-btn").onclick = upgradeTower;
  document.getElementById("sell-mode").onclick = ()=>{
    state.sellMode = !state.sellMode;
    document.getElementById("sell-mode").textContent =
      state.sellMode ? "Đang chế độ bán" : "Bật chế độ bán";
  };

  document.getElementById("start-wave").onclick = startWave;

  canvas.onclick = onCanvasClick;

  requestAnimationFrame(loop);
}

// ============ GAME FUNCTIONS ==============
function getCost(lv){ return [0,70,90,120,160][lv]; }

function placeTower(i){
  if(towers[i]){ log("Ô này đã có tháp"); return; }
  if(state.money < getCost(1)){ log("Không đủ tiền"); return; }
  towers[i] = {level:1,selected:false};
  state.money -= getCost(1);
  updateHUD();
  log("Đặt tháp ô " + (i+1));
}

function upgradeTower(){
  let idx = towers.findIndex(t=>t && t.selected);
  if(idx<0){ log("Chưa chọn tháp"); return; }

  let t = towers[idx];
  if(t.level>=4){ log("Đã tối đa"); return; }

  let cost = 40*t.level;
  if(state.money < cost){ log("Không đủ tiền"); return; }

  t.level++;
  state.money -= cost;
  updateHUD();
  log(`Upgrade ô ${idx+1} → Lv ${t.level}`);
}

function onCanvasClick(e){
  const rect = canvas.getBoundingClientRect();
  let mx = e.clientX - rect.left, my = e.clientY - rect.top;

  let clicked = -1;
  spots.forEach((s,i)=>{ if(Math.hypot(mx-s.x,my-s.y)<40) clicked=i; });

  if(clicked === -1) return;

  if(state.sellMode){
    if(towers[clicked]){
      state.money += Math.floor(getCost(towers[clicked].level)*0.5);
      towers[clicked]=null;
      updateHUD();
      log("Đã bán tháp");
    }
    return;
  }

  towers.forEach(t=>{ if(t) t.selected=false; });

  if(towers[clicked]){
    towers[clicked].selected = true;
    log("Chọn tháp ô "+(clicked+1));
  } else {
    placeTower(clicked);
  }
}

// ================== WAVE =======================
let spawnTimer = 0, spawnQueue=[];
function startWave(){
  if(state.running) return;
  state.running = true;
  state.wave++;
  updateHUD();

  let count = 6 + Math.floor(state.wave*1.2);
  spawnQueue = [];
  for(let i=0;i<count;i++){
    spawnQueue.push({
      hp:20+state.wave*8,
      speed:0.6+state.wave*0.03,
      src: ASSETS.enemies[i%4]
    });
  }
  log("Wave " + state.wave + " bắt đầu");
}

// ================= UPDATE ======================
function update(dt){
  if(state.running){
    spawnTimer -= dt;
    if(spawnQueue.length>0 && spawnTimer<=0){
      const e=spawnQueue.shift();
      const start=pct(pathPercent[0]);
      enemies.push({
        hp:e.hp,maxHp:e.hp,speed:e.speed,progress:0,x:start.x,y:start.y,src:e.src
      });
      spawnTimer = 0.8;
    }
    if(spawnQueue.length===0 && enemies.length===0){
      state.running = false;
      state.money += 30 + state.wave*6;
      updateHUD();
      log("Wave hoàn thành");
    }
  }

  // Move enemies
  for(let i=enemies.length-1;i>=0;i--){
    let en=enemies[i];
    let seg=Math.floor(en.progress);
    let next=Math.min(seg+1,pathPercent.length-1);

    let s=pct(pathPercent[seg]);
    let d=pct(pathPercent[next]);
    let dist=Math.hypot(d.x-s.x,d.y-s.y);

    en.progress += (en.speed*dt*80)/dist;

    let seg2=Math.floor(en.progress);
    let next2=Math.min(seg2+1,pathPercent.length-1);
    let s2=pct(pathPercent[seg2]);
    let d2=pct(pathPercent[next2]);
    let p=en.progress-seg2;

    en.x = s2.x + (d2.x-s2.x)*p;
    en.y = s2.y + (d2.y-s2.y)*p;

    if(en.progress >= pathPercent.length-1){
      state.hp--;
      enemies.splice(i,1);
      updateHUD();
      log("Quái vào nhà! HP -1");
      if(state.hp<=0){ reset(); }
    }
  }

  // Towers shoot
  towers.forEach((t,i)=>{
    if(!t) return;
    let pos=spots[i];
    t.cd=(t.cd||0)-dt;
    let range=120+(t.level-1)*20;

    if(t.cd<=0){
      let target=null, best=1e9;
      enemies.forEach(en=>{
        let d=Math.hypot(en.x-pos.x,en.y-pos.y);
        if(d<range && d<best){ best=d; target=en;}
      });

      if(target){
        let dmg=12+(t.level-1)*8;
        target.hp -= dmg;
        t.cd=0.9/(1+0.08*(t.level-1));

        if(target.hp<=0){
          enemies.splice(enemies.indexOf(target),1);
          state.money+=10;
          updateHUD();
          log("Quái chết +10 tiền");
        }
      }
    }
  });
}

// ================= DRAW ========================
function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.drawImage(imgs[ASSETS.map],0,0,W,H);

  spots.forEach((s,i)=>{
    ctx.beginPath();
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.ellipse(s.x,s.y,34,20,0,0,Math.PI*2);
    ctx.fill();

    let t=towers[i];
    if(t){
      let img=imgs[ ASSETS.towers[t.level-1] ];
      let w=img.width*0.6, h=img.height*0.6;
      ctx.drawImage(img,s.x-w/2,s.y-h/2-6,w,h);

      if(t.selected){
        ctx.beginPath();
        ctx.strokeStyle="rgba(255,255,255,0.7)";
        ctx.lineWidth=2;
        ctx.ellipse(s.x,s.y,42,26,0,0,Math.PI*2);
        ctx.stroke();
      }
    }
  });

  enemies.forEach(en=>{
    let img=imgs[en.src];
    ctx.drawImage(img,en.x-enemySize/2,en.y-enemySize/2,enemySize,enemySize);

    let pct=en.hp/en.maxHp;
    ctx.fillStyle="rgba(0,0,0,0.6)";
    ctx.fillRect(en.x-24,en.y-36,48,6);
    ctx.fillStyle="rgba(16,185,129,0.95)";
    ctx.fillRect(en.x-24,en.y-36,48*pct,6);
  });

  ctx.fillStyle='rgba(0,0,0,0.25)';
  ctx.fillRect(8,8,220,34);
  ctx.fillStyle='#cfefff';
  ctx.font='13px Inter';
  ctx.fillText("Tiền: "+state.money,16,30);
  ctx.fillText("HP: "+state.hp,110,30);
  ctx.fillText("Wave: "+state.wave,160,30);
}

// ================= LOOP ========================
let last = performance.now();
function loop(now){
  const dt=(now-last)/1000; last=now;
  if(loaded===totalImgs) update(dt);
  draw();
  requestAnimationFrame(loop);
}

// ================= UTILS =======================
function updateHUD(){
  document.getElementById("money").textContent=state.money;
  document.getElementById("hp").textContent=state.hp;
  document.getElementById("wave").textContent=state.wave;
}

function reset(){
  state.hp=10;
  state.money=150;
  state.wave=0;
  towers=new Array(6).fill(null);
  enemies=[];
  updateHUD();
  log("Reset game");
}
</script>
</body>
</html>
