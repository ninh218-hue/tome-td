
<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Anime Tower Defense - PNG Online Version</title>
<style>
  body{margin:0;background:#051022;color:#eaf6ff;font-family:Inter,Arial}
  .wrap{max-width:1100px;margin:18px auto;display:flex;gap:16px;padding:12px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  #game{background:#000;display:block;border-radius:8px}
  .sidebar{width:320px}
  .stat{display:flex;gap:8px;margin-bottom:10px}
  .stat div{flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}
  button{background:#10b981;border:none;color:#022;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .muted{color:#9aa6b2;font-size:13px}
  .spots{margin-top:10px}
  .spot{padding:6px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .log{margin-top:10px;max-height:220px;overflow:auto;padding:8px;border-radius:6px;background:rgba(255,255,255,0.01);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" style="flex:1">
    <canvas id="game" width="820" height="820"></canvas>
  </div>

  <div class="panel sidebar">
    <h3>Anime Tower Defense — PNG Online</h3>
    <div class="stat">
      <div>Tiền<br><strong id="money">150</strong></div>
      <div>HP<br><strong id="hp">10</strong></div>
      <div>Wave<br><strong id="wave">0</strong></div>
    </div>

    <div class="muted">Chỉ được đặt tháp trên 6 ô tròn.</div>

    <div style="margin-top:10px">
      <button id="start-wave">Start Wave</button>
      <button id="sell-mode" style="background:#ffd86b;color:#072028">Bật chế độ bán</button>
    </div>

    <div class="spots">
      <div class="muted" style="margin-top:8px">Các ô đặt tháp:</div>
      <div id="spots-list"></div>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:700">Chọn loại tháp:</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="select-tower">Chọn tháp (Lv1)</button>
        <button id="upgrade-btn" style="background:#7de3ff;color:#022">Upgrade</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>
</div>

<script>
const ASSETS = {
  map: "https://luutru.nctagency.com/wp-content/uploads/2025/11/3-1.png",
  towers: [
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/4-1.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/5.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/6.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/7.png"
  ],
  enemies: [
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/12.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/13.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/11.png",
    "https://luutru.nctagency.com/wp-content/uploads/2025/11/14.png"
  ]
};

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let imgs = {};
let loaded = 0, totalImgs = 0;

const toLoad = [ASSETS.map, ...ASSETS.towers, ...ASSETS.enemies];
totalImgs = toLoad.length;

toLoad.forEach(src=>{
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = src;
  img.onload = ()=>{ imgs[src]=img; loaded++; if(loaded===totalImgs) init(); };
  img.onerror = ()=>{ console.error('Load error:',src); loaded++; if(loaded===totalImgs) init(); };
});

// Game state
const state = { money:150, hp:10, wave:0, running:false, sellMode:false, selectedTowerIdx:0 };
const logEl = document.getElementById('log');
function log(t){ const d=document.createElement('div'); d.textContent=t; logEl.prepend(d); }

// Tower spots
const spotsPercent = [
  {x:0.18,y:0.16},
  {x:0.36,y:0.22},
  {x:0.60,y:0.28},
  {x:0.20,y:0.52},
  {x:0.44,y:0.68},
  {x:0.78,y:0.84}
];

let spots = [];
let towers = new Array(spotsPercent.length).fill(null);
let enemies = [];

const enemySize = 64;

// Path
const pathPercent = [
  {x:0.12,y:0.12},{x:0.24,y:0.18},{x:0.36,y:0.28},{x:0.48,y:0.38},
  {x:0.60,y:0.48},{x:0.68,y:0.58},{x:0.78,y:0.70},{x:0.88,y:0.78}
];

function pctToPx(p){ return {x: Math.round(p.x * W), y: Math.round(p.y * H)}; }

function init(){
  spots = spotsPercent.map(p=>pctToPx(p));
  const spotsList = document.getElementById('spots-list');
  spots.forEach((s,i)=>{
    const el = document.createElement('div'); el.className='spot';
    el.innerHTML = '<div>Ô '+(i+1)+'</div><div><button data-i="'+i+'">Đặt</button></div>';
    spotsList.appendChild(el);
  });

  document.querySelectorAll('#spots-list button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const i = Number(b.dataset.i);
      placeTower(i);
    });
  });

  document.getElementById('select-tower').addEventListener('click', ()=>{
    state.selectedTowerIdx = (state.selectedTowerIdx+1) % ASSETS.towers.length;
    document.getElementById('select-tower').textContent = 'Chọn tháp (Lv '+(state.selectedTowerIdx+1)+')';
  });

  document.getElementById('upgrade-btn').addEventListener('click', upgradeTower);
  document.getElementById('sell-mode').addEventListener('click', toggleSellMode);
  document.getElementById('start-wave').addEventListener('click', startWave);

  canvas.addEventListener('click', onCanvasClick);

  updateUI();
  requestAnimationFrame(loop);
}

function getTowerCost(level){ return [0,70,90,120,160][level] || 70; }

function placeTower(i){
  if(towers[i]){ log('Ô này đã có tháp'); return; }
  const cost = getTowerCost(1);
  if(state.money < cost){ log('Không đủ tiền'); return; }
  towers[i] = { level:1, selected:false };
  state.money -= cost;
  updateUI();
  log('Đặt tháp ô '+(i+1));
}

function upgradeTower(){
  const idx = towers.findIndex(t=>t && t.selected);
  if(idx === -1){ log('Chưa chọn tháp'); return; }

  const t = towers[idx];
  if(t.level >= 4){ log('Đã tối đa'); return; }

  const cost = 40 * t.level;
  if(state.money < cost){ log('Không đủ tiền'); return; }

  t.level++;
  state.money -= cost;
  updateUI();
  log('Upgrade ô '+(idx+1)+' lên Lv '+t.level);
}

function toggleSellMode(){
  state.sellMode = !state.sellMode;
  document.getElementById('sell-mode').textContent =
    state.sellMode ? "Đang chế độ bán" : "Bật chế độ bán";
}

function onCanvasClick(e){
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;

  let found = -1;
  spots.forEach((s,i)=>{
    if(Math.hypot(mx-s.x,my-s.y) < 40) found = i;
  });

  if(found === -1) return;

  if(state.sellMode){
    if(towers[found]){
      state.money += Math.floor(getTowerCost(towers[found].level)*0.5);
      towers[found] = null;
      updateUI();
      log('Đã bán tháp ô '+(found+1));
    }
    return;
  }

  towers.forEach(t=>{ if(t) t.selected=false; });

  if(towers[found]){
    towers[found].selected = true;
    log('Chọn tháp ô '+(found+1));
  } else {
    placeTower(found);
  }
}

let spawnQueue = [];
let spawnTimer = 0;

function startWave(){
  if(state.running) return;
  state.wave++; state.running = true;
  updateUI();

  spawnQueue = [];
  const count = 6 + Math.floor(state.wave * 1.2);

  for(let i=0;i<count;i++){
    spawnQueue.push({
      hp:20 + state.wave*8,
      speed:0.6 + state.wave*0.03,
      src: ASSETS.enemies[i % ASSETS.enemies.length]
    });
  }

  log('Wave '+state.wave+' bắt đầu');
}

function update(dt){
  if(state.running && spawnQueue.length>0){
    spawnTimer -= dt;
    if(spawnTimer <= 0){
      const e = spawnQueue.shift();
      const start = pctToPx(pathPercent[0]);
      enemies.push({hp:e.hp,maxHp:e.hp,speed:e.speed,progress:0,x:start.x,y:start.y,src:e.src});
      spawnTimer = 0.8;
    }
  } else if(state.running && spawnQueue.length===0 && enemies.length===0){
    state.running = false;
    state.money += 30 + state.wave*6;
    updateUI();
    log('Wave hoàn thành');
  }

  for(let i=enemies.length-1;i>=0;i--){
    const en = enemies[i];
    const seg = Math.floor(en.progress);
    const next = Math.min(seg+1, pathPercent.length-1);

    const sPos = pctToPx(pathPercent[seg]);
    const ePos = pctToPx(pathPercent[next]);
    const dist = Math.hypot(ePos.x-sPos.x,ePos.y-sPos.y);
    const move = en.speed * dt * 80;
    en.progress += move / dist;

    const seg2 = Math.floor(en.progress);
    const next2 = Math.min(seg2+1, pathPercent.length-1);
    const st = pctToPx(pathPercent[seg2]);
    const ed = pctToPx(pathPercent[next2]);
    const p = en.progress - seg2;
    en.x = st.x + (ed.x-st.x)*p;
    en.y = st.y + (ed.y-st.y)*p;

    if(en.progress >= pathPercent.length-1){
      state.hp--;
      enemies.splice(i,1);
      updateUI();
      log("Quái vào nhà! HP -1");

      if(state.hp <=0){
        log("Game Over! Đang reset...");
        resetGame();
      }
    }
  }

  towers.forEach((t,i)=>{
    if(!t) return;
    t.cd = (t.cd||0)-dt;

    const towerPos = spots[i];
    const range = 120 + (t.level-1)*20;

    if(t.cd <= 0){
      let target=null, best=1e9;

      enemies.forEach(en=>{
        const d=Math.hypot(en.x-towerPos.x,en.y-towerPos.y);
        if(d<range && d<best){ best=d; target=en; }
      });

      if(target){
        const dmg = 12 + (t.level-1)*8;
        target.hp -= dmg;

        t.cd = 0.9 / (1 + 0.08*(t.level-1));

        if(target.hp <=0){
          enemies.splice(enemies.indexOf(target),1);
          state.money += 10;
          updateUI();
          log("Quái chết +10 tiền");
        }
      }
    }
  });
}

let last = performance.now();
function loop(now){
  const dt = (now-last)/1000; last = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

function draw(){
  ctx.clearRect(0,0,W,H);

  const mapImg = imgs[ASSETS.map];
  if(mapImg) ctx.drawImage(mapImg,0,0,W,H);

  // Path soft overlay
  ctx.beginPath();
  pathPercent.forEach((p,i)=>{
    const pt=pctToPx(p);
    if(i===0) ctx.moveTo(pt.x,pt.y); else ctx.lineTo(pt.x,pt.y);
  });
  ctx.lineWidth=8;
  ctx.strokeStyle="rgba(255,255,255,0.04)";
  ctx.stroke();

  spots.forEach((s,i)=>{
    ctx.beginPath();
    ctx.fillStyle="rgba(255,255,255,0.03)";
    ctx.ellipse(s.x,s.y,34,20,0,0,Math.PI*2);
    ctx.fill();

    if(towers[i]){
      const t=towers[i];
      const img=imgs[ ASSETS.towers[t.level-1] ];
      if(img){
        const scale=0.6;
        const w=img.width*scale, h=img.height*scale;
        ctx.drawImage(img,s.x-w/2,s.y-h/2-6,w,h);
      }
      if(t.selected){
        ctx.beginPath();
        ctx.strokeStyle="rgba(255,255,255,0.6)";
        ctx.lineWidth=2;
        ctx.ellipse(s.x,s.y,42,26,0,0,Math.PI*2);
        ctx.stroke();
      }
    }
  });

  enemies.forEach(en=>{
    const img = imgs[en.src];
    if(img){
      ctx.drawImage(img, en.x-enemySize/2, en.y-enemySize/2, enemySize, enemySize);
    }
    const pct = Math.max(0,en.hp/en.maxHp);
    ctx.fillStyle="rgba(0,0,0,0.6)";
    ctx.fillRect(en.x-24,en.y-36,48,6);
    ctx.fillStyle="rgba(16,185,129,0.95)";
    ctx.fillRect(en.x-24,en.y-36,48*pct,6);
  });

  ctx.fillStyle='rgba(0,0,0,0.25)';
  ctx.fillRect(8,8,220,34);
  ctx.fillStyle='#cfefff';
  ctx.font='13px Inter';
  ctx.fillText('Tiền: '+state.money,16,30);
  ctx.fillText('HP: '+state.hp,110,30);
  ctx.fillText('Wave: '+state.wave,160,30);
}

function updateUI(){
  document.getElementById('money').textContent = state.money;
  document.getElementById('hp').textContent = state.hp;
  document.getElementById('wave').textContent = state.wave;
}

function resetGame(){
  state.hp=10;
  state.money=150;
  state.wave=0;
  towers = new Array(spots.length).fill(null);
  enemies=[];
  updateUI();
}
</script>
</body>
</html>
